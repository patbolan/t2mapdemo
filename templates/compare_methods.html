<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Methods - T2 Map Demo</title>
    
    <link rel="stylesheet" href="/static/css/shared.css">
    
    <!-- Shared JavaScript -->
    <script src="{{ url_for('static', filename='js/shared.js') }}"></script>
    
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
      /* Page-specific styles */
      body { 
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 { 
        margin-bottom: 1rem; 
        color: #333; 
      }
      
      /* Comparison grid layout */
      .comparison-grid {
        display: grid;
        grid-template-columns: auto 1fr 1fr 1fr;
        gap: 1rem;
        margin-top: 2rem;
        align-items: start;
      }
      
      /* Column headers */
      .column-header {
        text-align: center;
        margin-bottom: 0.5rem;
      }
      
      .image-title {
        margin: 0.5rem 0;
        font-weight: bold;
        color: #555;
      }
      
      /* Row headers */
      .row-header {
        font-weight: bold;
        color: var(--accent);
        padding: 0.5rem;
        text-align: right;
        white-space: nowrap;
        align-self: center;
      }
      
      /* Image cells */
      .grid-image {
        text-align: center;
      }
      
      .grid-image img {
        width: 100%;
        max-width: 300px;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      /* Text column using details-container styling */
      .grid-details {
        background: #d1d5db;
        border-radius: 8px;
        padding: 1rem;
        line-height: 1.6;
        color: #555;
        font-size: 0.9em;
      }
      
      /* Empty cell for top-left corner */
      .empty-cell {
        grid-column: 1;
        grid-row: 1;
      }
      
      /* Hide row 1 (ground truth) when needed */
      .row1-hidden {
        display: none;
      }
      
      /* Comparison slider styles */
      .comparison-slider {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        border-radius: 6px;
        cursor: default;
        user-select: none;
      }
      
      .slider-container {
        position: relative;
        width: 100%;
        max-width: 300px;
        height: 300px;
        margin: 0 auto;
        overflow: hidden;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      
      .comparison-base {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      
      .comparison-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 50%;
        height: 100%;
        overflow: hidden;
      }
      
      .comparison-overlay img {
        width: 300px;
        height: 300px;
        object-fit: cover;
        display: block;
      }
      
      .comparison-handle {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        height: 100%;
        width: 4px;
        background: white;
        cursor: ew-resize;
        z-index: 10;
      }
      
      .comparison-line {
        width: 2px;
        height: 100%;
        background: #007acc;
        margin: 0 auto;
        pointer-events: none;
      }
      
      .comparison-grip {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        background: #007acc;
        border: 2px solid white;
        border-radius: 50%;
        cursor: ew-resize;
      }
      
      .comparison-labels {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        padding: 0 15px;
        pointer-events: none;
      }
      
      .comparison-labels span {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .comparison-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }
        
        .column-header,
        .row-header {
          text-align: left;
        }
        
        .empty-cell {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <a href="/" class="back-link">‚Üê Back to Home</a>
    
    <h1>Compare Methods</h1>
    
    <div class="info-box">
      <p>These plots are a subset of <a href="https://link.springer.com/article/10.1007/s10334-024-01186-3/figures/2">Figure 2</a> 
        from the paper, which compares the performance of two different parameter estimation methods in the synthetic 
        test set. The images are compared to the correct (ground truth) parameter maps using three different 
        visualization methods. </p>
    </div>
    
    <div class="tab-container">
      <ul class="tab-nav">
        <li><button class="tab-btn active" data-tab="static">Static</button></li>
        <li><button class="tab-btn" data-tab="slider">Slider</button></li>
        <li><button class="tab-btn" data-tab="toggle">Toggle</button></li>
      </ul>
      
      <!-- Single dynamic tab content -->
      <div class="tab-content active" id="dynamic-content">
        <div class="tab-card">
          <div class="tab-description">
            <p id="tab-description"><!-- Dynamic description --></p>
          </div>
          
          <div class="comparison-grid">
            <!-- Empty top-left corner -->
            <div class="empty-cell"></div>
            
            <!-- Column headers -->
            <div class="column-header">
              <div class="image-title">
                <div style="font-size: 1.1em;">$S_0$ Parameter Map</div>
              </div>
            </div>
            <div class="column-header">
              <div class="image-title">
                <div style="font-size: 1.1em;">$T_2$ Parameter Map</div>
              </div>
            </div>
            <div class="column-header">
              <!-- Empty header for details column -->
            </div>
            
            <!-- Row 1: Ground Truth -->
            <div class="row-header row1-element" id="row1-header">Ground Truth</div>
            <div class="grid-image row1-element">
              <img id="row1-s0-img" src="" alt="Row 1 S0">
            </div>
            <div class="grid-image row1-element">
              <img id="row1-t2-img" src="" alt="Row 1 T2">
            </div>
            <div class="grid-details row1-element">
              <p id="row1-details"><!-- Dynamic details --></p>
            </div>
            
            <!-- Row 2: NLLS Fit -->
            <div class="row-header" id="row2-header">NLLS Fit</div>
            <div class="grid-image" id="row2-s0-container">
              <img id="row2-s0-img" src="" alt="Row 2 S0">
            </div>
            <div class="grid-image" id="row2-t2-container">
              <img id="row2-t2-img" src="" alt="Row 2 T2">
            </div>
            <div class="grid-details">
              <p id="row2-details"><!-- Dynamic details --></p>
            </div>
            
            <!-- Row 3: CNN -->
            <div class="row-header" id="row3-header">CNN</div>
            <div class="grid-image" id="row3-s0-container">
              <img id="row3-s0-img" src="" alt="Row 3 S0">
            </div>
            <div class="grid-image" id="row3-t2-container">
              <img id="row3-t2-img" src="" alt="Row 3 T2">
            </div>
            <div class="grid-details">
              <p id="row3-details"><!-- Dynamic details --></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Data injection -->
    <script id="labels-data" type="application/json">{{ labels | tojson }}</script>
    <script id="method1-data" type="application/json">{{ method1_preds | tojson }}</script>
    <script id="method2-data" type="application/json">{{ method2_preds | tojson }}</script>
    
    <script>
      // Load data from backend
      const labels = JSON.parse(document.getElementById('labels-data').textContent);
      const method1_preds = JSON.parse(document.getElementById('method1-data').textContent);
      const method2_preds = JSON.parse(document.getElementById('method2-data').textContent);
      
      // Configuration for each tab
      const tabConfig = {
        static: {
          description: `These side-by-side images show static comparisons of the parameter maps from ground truth, 
            NLLS fitting, and CNN predictions. All images are displayed simultaneously for direct visual comparison.`,
          row1: {
            header: 'Ground Truth',
            s0Data: labels.label_S0,
            t2Data: labels.label_T,
            details: 'Ground truth parameter maps generated from the synthetic data simulation.'
          },
          row2: {
            header: 'NLLS Fit',
            s0Data: method1_preds.pred_S0,
            t2Data: method1_preds.pred_T,
            details: 'Parameter maps estimated using Non-Linear Least Squares (NLLS) fitting algorithm.'
          },
          row3: {
            header: 'CNN',
            s0Data: method2_preds.pred_S0,
            t2Data: method2_preds.pred_T,
            details: 'Parameter maps estimated using Convolutional Neural Network (CNN) trained on ImageNet synthetic data.'
          }
        },
        slider: {
          description: `Use the slider to transition between different methods. This allows you to see differences 
            by smoothly blending between images, making subtle variations more apparent.`,
          hideRow1: true,
          row2: {
            header: 'NLLS Fit',
            s0Data: method1_preds.pred_S0,
            t2Data: method1_preds.pred_T,
            details: 'NLLS fit estimates (slider will blend between methods).'
          },
          row3: {
            header: 'CNN',
            s0Data: method2_preds.pred_S0,
            t2Data: method2_preds.pred_T,
            details: 'CNN estimates (slider will blend between methods).'
          }
        },
        toggle: {
          description: `Click on images to toggle between different methods. This provides an instant side-by-side 
            comparison by switching between methods at the same location.`,
          hideRow1: true,
          row2: {
            header: 'NLLS Fit',
            s0Data: method1_preds.pred_S0,
            t2Data: method1_preds.pred_T,
            details: 'NLLS fit estimates (click to toggle views).'
          },
          row3: {
            header: 'CNN',
            s0Data: method2_preds.pred_S0,
            t2Data: method2_preds.pred_T,
            details: 'CNN estimates (click to toggle views).'
          }
        }
      };
      
      // Function to update content based on selected tab
      function updateContent(tabKey) {
        const config = tabConfig[tabKey];
        
        let s0Colormap = 'gray';
        let tColormap = 'viridis';
        let s0Min = 0, s0Max = 1;
        let tMin = 0, tMax = 4; 
        
        // Update description
        document.getElementById('tab-description').innerHTML = config.description;
        
        // Show or hide row 1 based on config
        const row1Elements = document.querySelectorAll('.row1-element');
        if (config.hideRow1) {
          row1Elements.forEach(el => el.classList.add('row1-hidden'));
        } else {
          row1Elements.forEach(el => el.classList.remove('row1-hidden'));
          // Update row 1 content
          document.getElementById('row1-header').textContent = config.row1.header;
          document.getElementById('row1-s0-img').src = arrayToImageSrc(config.row1.s0Data, s0Colormap, s0Min, s0Max);
          document.getElementById('row1-t2-img').src = arrayToImageSrc(config.row1.t2Data, tColormap, tMin, tMax);
          document.getElementById('row1-details').innerHTML = config.row1.details;
        }
        
        // Determine if we need slider mode
        const isSliderMode = (tabKey === 'slider');
        
        // Update row 2
        document.getElementById('row2-header').textContent = config.row2.header;
        if (isSliderMode) {
          createComparisonSlider('row2-s0-container', 
            arrayToImageSrc(labels.label_S0, s0Colormap, s0Min, s0Max),
            arrayToImageSrc(config.row2.s0Data, s0Colormap, s0Min, s0Max),
            config.row2.header, 'Ground Truth');
          createComparisonSlider('row2-t2-container', 
            arrayToImageSrc(labels.label_T, tColormap, tMin, tMax),
            arrayToImageSrc(config.row2.t2Data, tColormap, tMin, tMax),
            config.row2.header, 'Ground Truth');
        } else {
          restoreSimpleImage('row2-s0-container', arrayToImageSrc(config.row2.s0Data, s0Colormap, s0Min, s0Max));
          restoreSimpleImage('row2-t2-container', arrayToImageSrc(config.row2.t2Data, tColormap, tMin, tMax));
        }
        document.getElementById('row2-details').innerHTML = config.row2.details;
        
        // Update row 3
        document.getElementById('row3-header').textContent = config.row3.header;
        if (isSliderMode) {
          createComparisonSlider('row3-s0-container', 
            arrayToImageSrc(labels.label_S0, s0Colormap, s0Min, s0Max),
            arrayToImageSrc(config.row3.s0Data, s0Colormap, s0Min, s0Max),
            config.row3.header, 'Ground Truth');
          createComparisonSlider('row3-t2-container', 
            arrayToImageSrc(labels.label_T, tColormap, tMin, tMax),
            arrayToImageSrc(config.row3.t2Data, tColormap, tMin, tMax),
            config.row3.header, 'Ground Truth');
        } else {
          restoreSimpleImage('row3-s0-container', arrayToImageSrc(config.row3.s0Data, s0Colormap, s0Min, s0Max));
          restoreSimpleImage('row3-t2-container', arrayToImageSrc(config.row3.t2Data, tColormap, tMin, tMax));
        }
        document.getElementById('row3-details').innerHTML = config.row3.details;
      }
      
      // Function to create a comparison slider
      function createComparisonSlider(containerId, baseImgSrc, overlayImgSrc, leftLabel, rightLabel) {
        const container = document.getElementById(containerId);
        
        container.innerHTML = `
          <div class="slider-container">
            <div class="comparison-slider" id="slider-${containerId}">
              <img class="comparison-base" src="${baseImgSrc}" alt="Base">
              <div class="comparison-overlay">
                <img src="${overlayImgSrc}" alt="Overlay">
              </div>
              <div class="comparison-handle">
                <div class="comparison-line"></div>
                <div class="comparison-grip"></div>
              </div>
              <div class="comparison-labels">
                <span class="label-left">${leftLabel}</span>
                <span class="label-right">${rightLabel}</span>
              </div>
            </div>
          </div>
        `;
        
        // Initialize slider functionality
        setTimeout(() => initComparisonSlider(`slider-${containerId}`), 50);
      }
      
      // Function to restore simple image (non-slider mode)
      function restoreSimpleImage(containerId, imgSrc) {
        const container = document.getElementById(containerId);
        const imgId = containerId.replace('-container', '-img');
        
        container.innerHTML = `<img id="${imgId}" src="${imgSrc}" alt="Parameter Map">`;
      }
      
      // Global slider state for synchronization
      let sliderState = {
        isDragging: false,
        currentSlider: null
      };
      
      // Comparison slider functionality
      function initComparisonSlider(sliderId) {
        const slider = document.getElementById(sliderId);
        if (!slider) return;
        
        const overlay = slider.querySelector('.comparison-overlay');
        const handle = slider.querySelector('.comparison-handle');
        const grip = slider.querySelector('.comparison-grip');
        
        function updateSlider(x) {
          const rect = slider.getBoundingClientRect();
          const percentage = Math.max(0, Math.min(100, (x - rect.left) / rect.width * 100));
          
          overlay.style.width = percentage + '%';
          handle.style.left = percentage + '%';
          
          return percentage;
        }
        
        function updateAllSliders(percentage) {
          // Update all comparison sliders to the same percentage
          document.querySelectorAll('.comparison-slider').forEach(s => {
            const overlay = s.querySelector('.comparison-overlay');
            const handle = s.querySelector('.comparison-handle');
            if (overlay && handle) {
              overlay.style.width = percentage + '%';
              handle.style.left = percentage + '%';
            }
          });
        }
        
        function startDrag(e) {
          // Only respond to left mouse button (button 0)
          if (e.button !== 0 && e.type !== 'touchstart') {
            return;
          }
          sliderState.isDragging = true;
          sliderState.currentSlider = slider;
          e.preventDefault();
          const percentage = updateSlider(e.clientX || e.touches[0].clientX);
          updateAllSliders(percentage);
        }
        
        function onDrag(e) {
          if (!sliderState.isDragging || sliderState.currentSlider !== slider) return;
          e.preventDefault();
          const percentage = updateSlider(e.clientX || e.touches[0].clientX);
          updateAllSliders(percentage);
        }
        
        function stopDrag() {
          if (sliderState.currentSlider === slider) {
            sliderState.isDragging = false;
            sliderState.currentSlider = null;
          }
        }
        
        // Mouse events - only on handle and grip
        handle.addEventListener('mousedown', startDrag);
        grip.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
        
        // Touch events for mobile - only on handle and grip
        handle.addEventListener('touchstart', startDrag);
        grip.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', onDrag);
        document.addEventListener('touchend', stopDrag);
      }
      
      // Initialize with default tab on page load
      document.addEventListener('DOMContentLoaded', function() {
        updateContent('static');
        
        // Render math with KaTeX
        renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
          ],
          throwOnError: false
        });
      });
      
      // Tab switching functionality
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          
          // Update button states
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Update content
          updateContent(tabName);
        });
      });
    </script>
  </body>
</html>
